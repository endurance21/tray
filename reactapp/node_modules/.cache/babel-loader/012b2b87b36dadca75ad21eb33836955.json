{"ast":null,"code":"var Sequence = require('./Sequence');\n\nvar Util = require('util');\n\nvar Packets = require('../packets');\n\nvar ResultSet = require('../ResultSet');\n\nvar ServerStatus = require('../constants/server_status');\n\nvar fs = require('fs');\n\nvar Readable = require('readable-stream');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\n\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = options.typeCast === undefined ? true : options.typeCast;\n  this.nestTables = options.nestTables || false;\n  this._resultSet = null;\n  this._results = [];\n  this._fields = [];\n  this._index = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function () {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function determinePacket(byte, parser) {\n  var resultSet = this._resultSet;\n\n  if (!resultSet) {\n    switch (byte) {\n      case 0x00:\n        return Packets.OkPacket;\n\n      case 0xff:\n        return Packets.ErrorPacket;\n\n      default:\n        return Packets.ResultSetHeaderPacket;\n    }\n  }\n\n  if (resultSet.eofPackets.length === 0) {\n    return resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount ? Packets.FieldPacket : Packets.EofPacket;\n  }\n\n  if (byte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (byte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  return Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function (packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet);\n\n  var results = this._results.length > 0 ? this._results : undefined;\n  var fields = this._fields.length > 0 ? this._fields : undefined;\n  err.index = this._index;\n  err.sql = this.sql;\n  this.end(err, results, fields);\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function (packet) {\n  if (packet.fieldCount === null) {\n    this._sendLocalDataFile(packet.extra);\n  } else {\n    this._resultSet = new ResultSet(packet);\n  }\n};\n\nQuery.prototype['FieldPacket'] = function (packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function (packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function (packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = this._results.length > 1 ? this._results : this._results[0];\n  var fields = this._fields.length > 1 ? this._fields : this._fields[0];\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function (packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function (path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    flag: 'r',\n    encoding: null,\n    autoClose: true\n  });\n  this.on('pause', function () {\n    localStream.pause();\n  });\n  this.on('resume', function () {\n    localStream.resume();\n  });\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function (options) {\n  var self = this;\n  options = options || {};\n  options.objectMode = true;\n  var stream = new Readable(options);\n\n  stream._read = function () {\n    self._connection && self._connection.resume();\n  };\n\n  stream.once('end', function () {\n    process.nextTick(function () {\n      stream.emit('close');\n    });\n  });\n  this.on('result', function (row, i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result', row, i); // replicate old emitter\n  });\n  this.on('error', function (err) {\n    stream.emit('error', err); // Pass on any errors\n  });\n  this.on('end', function () {\n    stream.push(null); // pushing null, indicating EOF\n  });\n  this.on('fields', function (fields, i) {\n    stream.emit('fields', fields, i); // replicate old emitter\n  });\n  return stream;\n};","map":{"version":3,"sources":["/home/endurance21/tray/node_modules/mysql/lib/protocol/sequences/Query.js"],"names":["Sequence","require","Util","Packets","ResultSet","ServerStatus","fs","Readable","module","exports","Query","inherits","options","callback","call","sql","values","typeCast","undefined","nestTables","_resultSet","_results","_fields","_index","_loadError","prototype","start","emit","ComQueryPacket","determinePacket","byte","parser","resultSet","OkPacket","ErrorPacket","ResultSetHeaderPacket","eofPackets","length","fieldPackets","resultSetHeaderPacket","fieldCount","FieldPacket","EofPacket","packetLength","RowDataPacket","packet","_callback","push","_handleFinalResultPacket","err","_packetToError","results","fields","index","end","_sendLocalDataFile","extra","rows","serverStatus","SERVER_MORE_RESULTS_EXISTS","connection","parse","path","self","localStream","createReadStream","flag","encoding","autoClose","on","pause","resume","data","LocalDataFilePacket","EmptyPacket","stream","objectMode","_read","_connection","once","process","nextTick","row","i"],"mappings":"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","sourcesContent":["var Sequence     = require('./Sequence');\nvar Util         = require('util');\nvar Packets      = require('../packets');\nvar ResultSet    = require('../ResultSet');\nvar ServerStatus = require('../constants/server_status');\nvar fs           = require('fs');\nvar Readable     = require('readable-stream');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = (options.typeCast === undefined)\n    ? true\n    : options.typeCast;\n  this.nestTables = options.nestTables || false;\n\n  this._resultSet = null;\n  this._results   = [];\n  this._fields    = [];\n  this._index     = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function() {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function determinePacket(byte, parser) {\n  var resultSet = this._resultSet;\n\n  if (!resultSet) {\n    switch (byte) {\n      case 0x00: return Packets.OkPacket;\n      case 0xff: return Packets.ErrorPacket;\n      default:   return Packets.ResultSetHeaderPacket;\n    }\n  }\n\n  if (resultSet.eofPackets.length === 0) {\n    return (resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount)\n      ? Packets.FieldPacket\n      : Packets.EofPacket;\n  }\n\n  if (byte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (byte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  return Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function(packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function(packet) {\n  var err = this._packetToError(packet);\n\n  var results = (this._results.length > 0)\n    ? this._results\n    : undefined;\n\n  var fields = (this._fields.length > 0)\n    ? this._fields\n    : undefined;\n\n  err.index = this._index;\n  err.sql   = this.sql;\n\n  this.end(err, results, fields);\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function(packet) {\n  if (packet.fieldCount === null) {\n    this._sendLocalDataFile(packet.extra);\n  } else {\n    this._resultSet = new ResultSet(packet);\n  }\n};\n\nQuery.prototype['FieldPacket'] = function(packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function(packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function(packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = (this._results.length > 1)\n    ? this._results\n    : this._results[0];\n\n  var fields = (this._fields.length > 1)\n    ? this._fields\n    : this._fields[0];\n\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function(packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function(path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    flag      : 'r',\n    encoding  : null,\n    autoClose : true\n  });\n\n  this.on('pause', function () {\n    localStream.pause();\n  });\n\n  this.on('resume', function () {\n    localStream.resume();\n  });\n\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function(options) {\n  var self = this;\n\n  options = options || {};\n  options.objectMode = true;\n\n  var stream = new Readable(options);\n\n  stream._read = function() {\n    self._connection && self._connection.resume();\n  };\n\n  stream.once('end', function() {\n    process.nextTick(function () {\n      stream.emit('close');\n    });\n  });\n\n  this.on('result', function(row, i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result', row, i);  // replicate old emitter\n  });\n\n  this.on('error', function(err) {\n    stream.emit('error', err);  // Pass on any errors\n  });\n\n  this.on('end', function() {\n    stream.push(null);  // pushing null, indicating EOF\n  });\n\n  this.on('fields', function(fields, i) {\n    stream.emit('fields', fields, i);  // replicate old emitter\n  });\n\n  return stream;\n};\n"]},"metadata":{},"sourceType":"script"}